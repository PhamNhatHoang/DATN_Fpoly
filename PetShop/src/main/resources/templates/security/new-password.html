<!DOCTYPE html>
<html
        lang="en"
        xmlns:th="http://www.thymeleaf.org"
        th:replace="~{/index.html::home(~{::body})}"
>
<head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Pet Shop</title>
    <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 15px;
        }
        .btn-custom {
            background: #aaccff;
            color: white;
        }
        .btn-custom:hover {
            background: #8cb3e6;
        }
    </style>
</head>

<body>
<div class="container-lg main-content px-3">
    <div class="d-flex align-items-center justify-content-center mt-5 mb-4">
        <h3 class="fw-bold font-resp text-danger">
            <i class="fa-regular fa-user"></i> Nhập mật khẩu mới
        </h3>
    </div>

    <div class="row">
        <div class="col-md-12 col-lg-8 offset-lg-2">
            <div class="card shadow">
                <div class="card-body">
                    <form action="/updateUserInfo" method="post">
                        <h5
                                class="alert font-resp"
                                th:if="${message}"
                                th:text="${message}"
                                th:classappend="${loginStatus == true ? 'alert-success' : 'alert-danger'}"
                        ></h5>

                        <div class="form-floating mb-3">
                            <input
                                    class="form-control"
                                    id="newPassword"
                                    name="newPassword"
                                    placeholder="Mật khẩu mới"
                                    required
                                    type="password"
                            />
                            <label for="newPassword">Nhập mật khẩu mới</label>
                        </div>

                        <div class="form-floating mb-3">
                            <input
                                    class="form-control"
                                    id="confirmPassword"
                                    name="confirmPassword"
                                    placeholder="Nhập lại mật khẩu mới"
                                    required
                                    type="password"
                            />
                            <label for="confirmPassword">Xác nhận mật khẩu mới</label>
                        </div>
                        <div class="d-flex justify-content-end gap-3 mb-4">
                            <button type="button" class="button-image" id="saveButton">
                                Lưu
                            </button>
                        </div>
                        <div class="d-flex justify-content-center mb-4"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thông Báo -->
    <div
            class="modal fade"
            id="notificationModal"
            tabindex="-1"
            aria-labelledby="notificationModalLabel"
            aria-hidden="true"
    >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">Thông Báo</h5>
                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body" id="modalMessage">
                    <!-- Thông báo sẽ hiển thị ở đây -->
                </div>
                <div class="modal-footer">
                    <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                    >
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" data-bs-backdrop="static" id="countdownModal" tabindex="-1" aria-labelledby="modalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Thông báo</h5>
                </div>
                <div class="modal-body">
                    <p id="modal-message"></p>
                    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                        <div id="progressBar"
                             class="progress-bar bg-danger progress-bar-striped progress-bar-animated"
                             style="width: 0"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    function validatePassword(password) {
        const passwordRegex =
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
        return passwordRegex.test(password);
    }
    let userData = {}; // Biến toàn cục để lưu trữ dữ liệu người dùng
    let mainUsername;
    window.onload = function () {
        // Lấy URL hiện tại
        const url = window.location.href;

        // Tách phần đường dẫn và query (phần sau dấu ?)
        const urlObject = new URL(url);

        // Lấy username từ đường dẫn
        const pathSegments = urlObject.pathname.split("/");
        username = pathSegments[pathSegments.length - 1]; // Gán giá trị vào biến username
        mainUsername = username;
        // Lấy token từ query params
        const params = new URLSearchParams(urlObject.search);
        const token = params.get("token");

        // Gọi API và xử lý kết quả
        fetch(`/api/user/new-password/${username}?token=${token}`)
            .then((response) => response.json()) // Giả sử server trả về JSON
            .then((data) => {
                userData = data; // Lưu dữ liệu vào biến toàn cục
                console.log("Dữ liệu API:", data); // Hiển thị dữ liệu lấy được từ API
            })
            .catch((error) => {
                console.error("Lỗi khi gọi API:", error);
            });
    };

    // Xử lý sự kiện khi nhấn nút "Lưu"
    document
        .getElementById("saveButton")
        .addEventListener("click", function () {
            const saveButton = document.getElementById("saveButton");
            saveButton.innerHTML =
                '<i class="fa fa-spinner fa-spin"></i> Đang xử lý...';
            saveButton.disabled = true;
            var newPassword = document.getElementById("newPassword").value;
            var confirmPassword =
                document.getElementById("confirmPassword").value;

            if (!validatePassword(newPassword)) {
                showModal(
                    "Mật khẩu phải chứa ít nhất 8 ký tự bao gồm số, chữ thường, chữ hoa, và ký tự đặc biệt."
                );
                saveButton.disabled = false;
                saveButton.innerHTML = "Đăng kí";
                return;
            }
            if (newPassword !== confirmPassword) {
                showModal("Mật khẩu và xác nhận mật khẩu phải giống nhau.");
                saveButton.disabled = false;
                saveButton.innerHTML = "Đăng kí";
                return;
            }

            userData.newPassword = newPassword; // Gán mật khẩu mới cho userData

            // Gọi API để gửi dữ liệu
            fetch(`/api/user/change-password/${mainUsername}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(userData), // Gửi dữ liệu người dùng
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Có lỗi xảy ra khi gửi dữ liệu.");
                    }
                    return response.json();
                })
                .then((data) => {
                    console.log("Kết quả khi gửi dữ liệu:", data);
                    var countdown = 3;
                    var modalMessage = document.getElementById("modal-message");
                    var progressBar = document.getElementById("progressBar");
                    var redirectUrl = "/login";
                    var myModal = new bootstrap.Modal(
                        document.getElementById("countdownModal")
                    );
                    myModal.show();

                    var progressWidth = 0; // Khởi tạo chiều rộng thanh tiến trình
                    var interval = setInterval(function () {
                        modalMessage.innerHTML =
                            "Đổi mật khẩu thành công! Chuyển hướng sau " + countdown + " giây.";
                        // Cập nhật thanh tiến trình
                        progressWidth += 50;
                        progressBar.style.width = progressWidth + "%";
                        countdown--;
                        if (countdown < 0) {
                            clearInterval(interval);
                            myModal.hide(); // Đóng modal
                            window.location.href = redirectUrl;
                        }
                    }, 1000);

                })
                .catch((error) => {
                    console.error("Lỗi khi gửi dữ liệu:", error);
                    showModal("Có lỗi xảy ra khi cập nhật mật khẩu."); // Hiển thị thông báo lỗi
                }).finally(() => {
                saveButton.innerHTML = "Đăng kí"; // Đưa lại nội dung nút về ban đầu
                saveButton.disabled = false; // Kích hoạt lại nút
            });
        });

    // Hàm hiển thị modal thông báo
    function showModal(message) {
        document.getElementById("modalMessage").innerText = message; // Cập nhật thông điệp
        var myModal = new bootstrap.Modal(
            document.getElementById("notificationModal")
        );
        myModal.show(); // Hiển thị modal
    }
</script>
</div>
</body>
</html>